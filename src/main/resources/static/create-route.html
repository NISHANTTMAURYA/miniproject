<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Route Management</title>
  <style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f0f0f0;
    }
    h1, h2 {
        color: #333;
    }
    form {
        background-color: #fff;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }
    label {
        display: block;
        margin-bottom: 5px;
    }
    input, select {
        width: 100%;
        padding: 8px;
        margin-bottom: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
    }
    button {
        background-color: #4CAF50;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    button:hover {
        background-color: #45a049;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        background-color: #fff;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    th, td {
        text-align: left;
        padding: 12px;
        border-bottom: 1px solid #ddd;
    }
    th {
        background-color: #f2f2f2;
        font-weight: bold;
    }
    .edit-btn, .save-btn, .cancel-btn {
        padding: 5px 10px;
        margin-right: 5px;
    }
    .edit-btn {
        background-color: #008CBA;
    }
    .save-btn {
        background-color: #4CAF50;
    }
    .cancel-btn {
        background-color: #f44336;
    }
    #successMessage {
        color: green;
        margin-bottom: 10px;
    }
    #errorMessage {
        color: red;
        margin-bottom: 10px;
    }
  </style>
</head>
<body>

<h1>All Routes</h1>
<label for="username">Username:</label>
<select id="username" name="username" required>
  <option value="">Select a user</option>
</select>
<button id="deleteSelected" style="display:none;">Delete Selected</button>
<table id="routesTable">
  <thead>
  <tr>
    <th><input type="checkbox" id="selectAll"></th>
    <th>ID</th>
    <th>End Location</th>
    <th>End Location Pincode</th>
    <th>Mode of Transport</th>
    <th>Username</th>
    <th>Coordinates</th>
    <th>Actions</th>
  </tr>
  </thead>
  <tbody>
  <!-- Rows will be dynamically added here -->
  </tbody>
</table>
<h1>Route Management</h1>

<div id="successMessage"></div>
<div id="errorMessage"></div>

<form id="routeForm">
  <h2>Create a New Route</h2>

  <label for="endLocation">End Location:</label>
  <input type="text" id="endLocation" name="endLocation" required>

  <label for="pincode">End Location Pincode:</label>
  <input type="text" id="pincode" name="pincode" required>

  <label for="modeOfTransport">Mode of Transport:</label>
  <input type="text" id="modeOfTransport" name="modeOfTransport" required>



  <button type="submit">Create Route</button>
</form>


<script>
  document.addEventListener("DOMContentLoaded", function() {
      const routeForm = document.getElementById('routeForm');
      const routesTable = document.getElementById('routesTable');
      const deleteSelectedBtn = document.getElementById('deleteSelected');
      const selectAllCheckbox = document.getElementById('selectAll');
      const usernameDropdown = document.getElementById('username');

      function showMessage(message, isError = false) {
          const messageElement = isError ? document.getElementById('errorMessage') : document.getElementById('successMessage');
          messageElement.textContent = message;
          setTimeout(() => {
              messageElement.textContent = '';
          }, 5000);
      }

      function fetchUsernames() {
    fetch('/route-management/users')
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`HTTP error! status: ${response.status}, body: ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.length === 0) {
                showMessage('No users found.', true);
                return;
            }
            const userOptions = data.map(username => `<option value="${username}">${username}</option>`).join('');
            usernameDropdown.innerHTML = '<option value="">Select a user</option>' + userOptions;
        })
        .catch(error => {
            console.error('Error fetching usernames:', error);
            showMessage('Error fetching usernames: ' + error.message, true);
        });
}

      async function fetchUserHomeAddress(username) {
        const response = await fetch(`/user-management/home-address?username=${encodeURIComponent(username)}`);
        if (!response.ok) {
          throw new Error('Failed to fetch home address');
        }
        return response.json();
      }

      async function fetchRoutes(username = '') {
        try {
            let url = '/route-management/routes';
            if (username) {
                url += `?username=${encodeURIComponent(username)}`;
            }

            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();

            const routesTableBody = routesTable.querySelector('tbody');
            routesTableBody.innerHTML = '';

            if (data.length === 0) {
                showMessage('No routes found for the selected user.', true);
                return;
            }

            for (const route of data) {
                let startCoords = null;
                if (route.username) {
                    try {
                        console.log('Fetching home address for user:', route.username);
                        
                        const userResponse = await fetch(`/user-management/home-address?username=${encodeURIComponent(route.username)}`);
                        if (!userResponse.ok) {
                            console.error('User response not OK:', await userResponse.text());
                            throw new Error('Failed to fetch home address');
                        }
                        
                        const userData = await userResponse.json();
                        console.log('User data received:', userData);
                        
                        if (userData && userData.homeAddress && userData.pincode) {
                            const fullAddress = `${userData.homeAddress} ${userData.pincode}`;
                            console.log('Attempting to geocode address:', fullAddress);
                            startCoords = await geocodeAddress(fullAddress);
                            
                            if (!startCoords) {
                                console.warn('Geocoding failed for address:', fullAddress);
                            }
                        } else {
                            console.warn('Incomplete user data:', userData);
                        }
                    } catch (error) {
                        console.error('Error in address processing:', error);
                    }
                }
                
                let endCoords = null;
                try {
                    endCoords = await geocodeAddress(route.endLocation + ' ' + route.pincode);
                } catch (error) {
                    console.error('Error fetching end coordinates:', error);
                }
                
                const row = document.createElement('tr');
                row.dataset.id = route.id;
                row.innerHTML = `
                    <td><input type="checkbox" class="route-checkbox"></td>
                    <td>${route.id}</td>
                    <td>${route.endLocation}</td>
                    <td>${route.pincode}</td>
                    <td>${route.modeOfTransport}</td>
                    <td>${route.username || 'N/A'}</td>
                    <td>
                        <strong>Start:</strong> ${startCoords ? `${startCoords.lat.toFixed(6)}, ${startCoords.lng.toFixed(6)}` : 'N/A'}<br>
                        <strong>End:</strong> ${endCoords ? `${endCoords.lat.toFixed(6)}, ${endCoords.lng.toFixed(6)}` : 'N/A'}
                    </td>
                    <td>
                        <button class="edit-btn">Edit</button>
                        <button class="save-btn" style="display:none;">Save</button>
                        <button class="cancel-btn" style="display:none;">Cancel</button>
                    </td>
                `;
                routesTableBody.appendChild(row);
            }
        } catch (error) {
            console.error('Error:', error);
            showMessage('Error fetching routes: ' + error.message, true);
        }
      }

      function updateDeleteSelectedButton() {
          const checkedBoxes = document.querySelectorAll('.route-checkbox:checked');
          deleteSelectedBtn.style.display = checkedBoxes.length > 0 ? 'inline-block' : 'none';
      }

      // Fetch usernames and routes when the page loads
      fetchUsernames();
      fetchRoutes();

      routeForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(routeForm);
    const routeData = Object.fromEntries(formData.entries());

    // Add the selected username to the routeData
    routeData.username = usernameDropdown.value; // Get the selected username

    fetch('/route-management/routes', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(routeData),
    })
    .then(response => response.json())
    .then(data => {
        showMessage('Route created successfully!');
        routeForm.reset();
        fetchRoutes(); // Refresh the routes table
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Error creating route.', true);
    });
});



      routesTable.addEventListener('click', function(e) {
          if (e.target.classList.contains('edit-btn')) {
              const row = e.target.closest('tr');
              row.querySelectorAll('td:not(:last-child):not(:first-child)').forEach(cell => {
                  const value = cell.textContent;
                  cell.innerHTML = `<input type="text" value="${value}">`;
              });
              row.querySelector('.edit-btn').style.display = 'none';
              row.querySelector('.save-btn').style.display = 'inline-block';
              row.querySelector('.cancel-btn').style.display = 'inline-block';
          } else if (e.target.classList.contains('save-btn')) {
              const row = e.target.closest('tr');
              const id = row.dataset.id;
              const updatedData = {
                  id: id,
                  endLocation: row.cells[2].querySelector('input').value,
                  pincode: row.cells[3].querySelector('input').value,
                  modeOfTransport: row.cells[4].querySelector('input').value,
                  username: row.cells[5].querySelector('input').value
              };

              fetch(`/route-management/routes/${id}`, {
                  method: 'PUT',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify(updatedData),
              })
              .then(response => response.json())
              .then(data => {
                  showMessage('Route updated successfully!');
                  fetchRoutes();
              })
              .catch(error => {
                  console.error('Error:', error);
                  showMessage('Error updating route.', true);
              });
          } else if (e.target.classList.contains('cancel-btn')) {
              fetchRoutes();
          }
      });

      deleteSelectedBtn.addEventListener('click', function() {
    const selectedRoutes = Array.from(document.querySelectorAll('.route-checkbox:checked'))
        .map(checkbox => checkbox.closest('tr').dataset.id);

    if (selectedRoutes.length === 0) return;

    // Confirm deletion
    const confirmation = confirm(`Are you sure you want to delete the selected routes? (${selectedRoutes.length} selected)`);
    if (!confirmation) return; // If not confirmed, exit

    fetch('/route-management/routes', {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(selectedRoutes),
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.text(); // Change to text() to handle empty response
    })
    .then(data => {
        showMessage('Selected routes deleted successfully!'); // Success message
        fetchRoutes(); // Refresh routes
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Error deleting routes: ' + error.message, true); // Show error message
    });
});



      selectAllCheckbox.addEventListener('change', function() {
          const checkboxes = document.querySelectorAll('.route-checkbox');
          checkboxes.forEach(checkbox => checkbox.checked = this.checked);
          updateDeleteSelectedButton();
      });

      routesTable.addEventListener('change', function(e) {
          if (e.target.classList.contains('route-checkbox')) {
              updateDeleteSelectedButton();
          }
      });

      // Add event listener for username dropdown
      usernameDropdown.addEventListener('change', function(e) {
          fetchRoutes(e.target.value);
      });

      async function geocodeAddress(address) {
        const apiKey = '9289340160b7436ba65e6add726263b7'; // Using the API key from your properties file
        const encodedAddress = encodeURIComponent(address);
        const url = `https://api.opencagedata.com/geocode/v1/json?q=${encodedAddress}&key=${apiKey}`;

        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error('Geocoding request failed');
            }
            const data = await response.json();
            if (data.results && data.results.length > 0) {
                return data.results[0].geometry;
            }
            throw new Error('No results found for address');
        } catch (error) {
            console.error('Geocoding error:', error);
            return null;
        }
      }

      // Add this after defining geocodeAddress function
      async function testGeocoding() {
          const testAddress = "Mumbai 400001";
          const result = await geocodeAddress(testAddress);
          console.log('Test geocoding result:', result);
      }
      // Call it once to verify
      testGeocoding();
  });
</script>
</body>
</html>